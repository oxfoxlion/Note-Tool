# Work Log - 2026-02-20

## Scope

本次主要聚焦在卡片操作一致性、`CardDetailClient` 可維護性重構，以及白板移除卡片後的即時更新行為。

## Completed

1. 統一卡片 `...` 選單操作
- 各入口（白板 modal/側欄、卡片頁、全頁）整合為一致選項：
  - Share card
  - Remove from board
  - Delete card

2. 抽離重複邏輯與元件化
- 新增共享 hooks：
  - `hooks/useClickOutside.ts`
  - `hooks/useCardShare.ts`
  - `hooks/useCardBoardMembership.ts`
  - `hooks/useCardActions.ts`
  - `hooks/useCardDetailState.ts`
  - `hooks/useCardLinks.ts`
  - `hooks/useCardMentions.ts`
  - `hooks/useMarkdownEditorTools.ts`
- 新增共享元件：
  - `components/cards/CardActionsMenu.tsx`
  - `components/cards/CardShareLinksModal.tsx`
  - `components/cards/CardRemoveFromBoardModal.tsx`
  - `components/cards/detail/CardEditorToolbar.tsx`
  - `components/cards/detail/CardMentionPicker.tsx`
  - `components/cards/detail/LinkedCardsList.tsx`
  - `components/cards/detail/CardMarkdownEditor.tsx`
  - `components/cards/detail/CardMarkdownPreview.tsx`
  - `components/cards/detail/CardViewModeSwitch.tsx`
  - `components/cards/detail/CardEditorPane.tsx`
  - `components/cards/detail/CardPreviewPane.tsx`

3. `CardDetailClient` 重構
- `app/(app)/cards/[id]/CardDetailClient.tsx` 由接近千行逐步拆分為頁面組裝層。
- 編輯器工具列、mention、preview、linked cards、share/remove/delete 行為抽離至 hooks/元件。

4. Card Box 列表交互調整
- 依產品決策移除 `app/(app)/cards/page.tsx` 列表卡片上的 `...`。
- 改為「點開卡片後」才提供操作選單。

5. 修正分享/移除點擊無反應
- 在 `Card Box` 頁面修正同一 click 內 state 尚未更新造成的 race。
- `openShare` / `openRemovePicker` 支援直接帶入目標 `cardId`。

6. 修正白板操作問題
- 修正 `CardOverlay` 缺少 `useRef` import 造成 runtime error。
- 修正白板拖曳 pointer capture 邊界處理，避免拖曳中斷。
- 修正白板內從 modal 執行移除後流程：
  - 成功後自動關閉 remove modal
  - 自動關閉 card overlay
  - 白板卡片由本地 state 立即移除（不需手動 refresh）

## Behavior Changes

1. `Card Box` 列表不再顯示 `...`。
2. 卡片操作集中在卡片內容視圖（modal/sidepanel/full page）。
3. 白板移除卡片成功後，會即時反映於畫面。

## Validation

本次修改後，相關檔案已通過 ESLint（分批驗證）。

## Follow-up

1. 可再把 `CardOverlay` 進一步拆分（與 `CardDetailClient` 對齊）。
2. 視需求補 E2E 測試（特別是 share/remove/delete 與白板拖曳）。
